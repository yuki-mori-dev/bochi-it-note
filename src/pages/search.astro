---
import BaseLayout from "../layouts/BaseLayout.astro";
import CrossSellTemplates from "../components/CrossSellTemplates.astro";
import products from "../../data/products.json";
import comparisons from "../../data/comparisons.json"; // 最小構成: 未使用だがスクリプト互換のため維持
const productMap = Object.fromEntries(products.map(p => [p.slug, p]));
const title = '探す（キーワード + 要件フィルタ）｜Bochi IT Note';
const description = '製品・比較を横断し、要件（SSO/SCIM/IP制限/監査/データ所在）でも絞り込み';
---

<BaseLayout {title} {description}>
	<h1 class="text-2xl font-bold">探す</h1>
	<div class="mt-4 grid gap-4 sm:grid-cols-[280px,1fr]">
		<aside class="rounded-md border p-4">
			<h2 class="font-semibold">要件</h2>
			<label class="mt-2 flex items-center gap-2 text-sm"><input type="checkbox" data-k="sso"/> SSO</label>
			<label class="mt-2 flex items-center gap-2 text-sm"><input type="checkbox" data-k="scim"/> SCIM</label>
			<label class="mt-2 flex items-center gap-2 text-sm"><input type="checkbox" data-k="ipAllowlist"/> IP制限</label>
			<label class="mt-2 flex items-center gap-2 text-sm"><input type="checkbox" data-k="mfa"/> 二要素認証</label>
			<div class="mt-3">
				<label class="block text-xs text-gray-600">データ所在</label>
				<select data-k="dataResidency" class="mt-1 w-full rounded border px-2 py-1 text-sm">
					<option value="">指定なし</option>
					<option value="jp">jp</option>
					<option value="eu">eu</option>
					<option value="us">us</option>
					<option value="multiple">multiple</option>
				</select>
			</div>
			<div class="mt-3">
				<label class="block text-xs text-gray-600">監査ログ</label>
				<select data-k="auditLog" class="mt-1 w-full rounded border px-2 py-1 text-sm">
					<option value="">指定なし</option>
					<option value="basic">basic</option>
					<option value="advanced">advanced</option>
				</select>
			</div>
		</aside>
		<section>
			<input id="q" class="w-full rounded border px-3 py-2" placeholder="製品名・比較（例: GitHub, Slack vs Teams）" />
			<!-- 最小構成のため検索/クリアボタンは一時コメントアウト
			<div class="mt-2 flex gap-2">
				<button type="button" id="searchBtn" class="cursor-pointer rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 hover:bg-gray-50">検索</button>
				<button type="button" id="clearBtn" class="cursor-pointer rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 hover:bg-gray-50">クリア</button>
			</div>
			-->
			<div id="res" class="mt-4">
				<h2 class="mt-4 text-lg font-semibold">製品</h2>
				<ul id="list" class="mt-2 grid gap-4 sm:grid-cols-2">
					{products.map(p => (
						<li class="rounded-md border p-4" data-product data-name={p.name.toLowerCase()} data-slug={p.slug} data-sso={String(p.features.sso)} data-scim={String(p.features.scim)} data-ip={String(p.features.ipAllowlist)} data-mfa={String(p.features.mfa)} data-dr={(p.features.dataResidency||'').toLowerCase()} data-audit={(p.features.auditLog||'').toLowerCase()}>
							<a href={`/products/${p.slug}`} class="font-semibold text-gray-900 hover:underline">{p.name}</a>
							<p class="mt-1 text-sm text-gray-600">SSO: {p.features.sso ? '対応' : '未対応'} / SCIM: {p.features.scim ? '対応' : '未対応'} / IP制限: {p.features.ipAllowlist ? '対応' : '未対応'}</p>
						</li>
					))}
				</ul>
				<h2 class="mt-6 text-lg font-semibold">比較</h2>
				<ul id="list-comparisons" class="mt-2 grid gap-4 sm:grid-cols-2">
					{comparisons.map(c => (
						<li class="rounded-md border p-4" data-comparison data-title={c.title.toLowerCase()} data-slug={c.slug} data-product-a={c.productA} data-product-b={c.productB} data-product-a-name={(products.find(p => p.slug === c.productA) || {name:''}).name.toLowerCase()} data-product-b-name={(products.find(p => p.slug === c.productB) || {name:''}).name.toLowerCase()}>
							<a href={`/compare/${c.slug}`} class="font-semibold text-gray-900 hover:underline">{c.title}</a>
							{c.summary && <p class="mt-1 text-sm text-gray-600">{c.summary}</p>}
						</li>
					))}
				</ul>
			</div>
		</section>
	</div>
	<section class="mt-8">
		<h2 class="text-lg font-semibold">更新を受け取る</h2>
		<p class="mt-1 text-sm text-gray-600">比較や要件更新、テンプレ追加をお知らせします。</p>
		<div class="mt-3" set:html={import.meta.env.PUBLIC_NEWSLETTER_EMBED || ''}></div>
	</section>
	<CrossSellTemplates title="検索に関連するテンプレ" count={2} />

	<script is:inline>
		(function(){
			try{
				var input=document.getElementById('q');
				var productItems=[].slice.call(document.querySelectorAll('[data-product]'));
				var comparisonItems=[].slice.call(document.querySelectorAll('[data-comparison]'));
				function apply(){
					var q=(input && input.value||'').toLowerCase().trim();
					var sso = document.querySelector('input[data-k="sso"]');
					var scim = document.querySelector('input[data-k="scim"]');
					var ip = document.querySelector('input[data-k="ipAllowlist"]');
					var mfa = document.querySelector('input[data-k="mfa"]');
					var dr = document.querySelector('select[data-k="dataResidency"]');
					var audit = document.querySelector('select[data-k="auditLog"]');
					var f = {
						sso: !!(sso && sso.checked),
						scim: !!(scim && scim.checked),
						ip: !!(ip && ip.checked),
						mfa: !!(mfa && mfa.checked),
						dr: (dr && dr.value)||'',
						audit: (audit && audit.value)||''
					};
					for(var i=0;i<productItems.length;i++){
						var li=productItems[i];
						var name=(li.getAttribute('data-name')||'').toLowerCase();
						var slug=(li.getAttribute('data-slug')||'').toLowerCase();
						var liSso = (li.getAttribute('data-sso')||'').toLowerCase()==='true';
						var liScim = (li.getAttribute('data-scim')||'').toLowerCase()==='true';
						var liIp = (li.getAttribute('data-ip')||'').toLowerCase()==='true';
						var liMfa = (li.getAttribute('data-mfa')||'').toLowerCase()==='true';
						var liDr = (li.getAttribute('data-dr')||'').toLowerCase();
						var liAudit = (li.getAttribute('data-audit')||'').toLowerCase();
						var show = !q || name.indexOf(q)>=0 || slug.indexOf(q)>=0;
						if(show){
							if(f.sso && !liSso) show=false;
							if(f.scim && !liScim) show=false;
							if(f.ip && !liIp) show=false;
							if(f.mfa && !liMfa) show=false;
							if(f.dr && liDr!==f.dr) show=false;
							if(f.audit && liAudit!==f.audit) show=false;
						}
						li.style.display = show ? '' : 'none';
					}
					for(var j=0;j<comparisonItems.length;j++){
						var ci=comparisonItems[j];
						var title=(ci.getAttribute('data-title')||'').toLowerCase();
						var cslug=(ci.getAttribute('data-slug')||'').toLowerCase();
						var pa=(ci.getAttribute('data-product-a')||'').toLowerCase();
						var pb=(ci.getAttribute('data-product-b')||'').toLowerCase();
						var pan=(ci.getAttribute('data-product-a-name')||'').toLowerCase();
						var pbn=(ci.getAttribute('data-product-b-name')||'').toLowerCase();
						var cshow = !q || title.indexOf(q)>=0 || cslug.indexOf(q)>=0 || pa.indexOf(q)>=0 || pb.indexOf(q)>=0 || pan.indexOf(q)>=0 || pbn.indexOf(q)>=0;
						if(cshow){
							// 比較は両製品が要件を満たすときのみ表示
							var aEl = document.querySelector('[data-product][data-slug="'+pa+'"]');
							var bEl = document.querySelector('[data-product][data-slug="'+pb+'"]');
							if(aEl && aEl.style.display==='none') cshow=false;
							if(bEl && bEl.style.display==='none') cshow=false;
						}
						ci.style.display = cshow ? '' : 'none';
					}
				}
				if(input){ input.addEventListener('input', apply); }
				var filterNodes = document.querySelectorAll('input[type="checkbox"][data-k], select[data-k]');
				for(var fn=0; fn<filterNodes.length; fn++){
					filterNodes[fn].addEventListener('change', apply);
				}
				apply();
			}catch(e){
				var res=document.getElementById('res');
				if(res){ res.innerHTML = '<div class="rounded-md border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">検索の初期化に失敗しました。ページを再読み込みしてください。</div>'; }
			}
		})();
	</script>
</BaseLayout>


