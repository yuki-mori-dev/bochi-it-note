---
import BaseLayout from "../../layouts/BaseLayout.astro";
import products from "../../../data/products.json";
import comparisons from "../../../data/comparisons.json";
import affiliates from "../../../data/affiliates.json";
import freshness from "../../../data/freshness.json";
import Breadcrumb from "../../components/Breadcrumb.astro";
import SponsorSlot from "../../components/SponsorSlot.astro";
export function getStaticPaths() {
  return products.map(p => ({ params: { slug: p.slug } }));
}
const { slug } = Astro.params;
const product = products.find(p => p.slug === slug);
if (!product) {
  throw new Error(`Product not found: ${slug}`);
}
const related = comparisons.filter(c => c.productA === product.slug || c.productB === product.slug);
const title = `${product.name}｜要件適合と機能`;
const description = `${product.name}のSSO/SCIM、IP制限、監査ログ、データ所在、保持期間などの要件適合状況。`;
const affiliate = affiliates.find(a => a.slug === product.slug) ?? affiliates.find(a => a.slug === 'default');
const useSkim = Boolean(import.meta.env.PUBLIC_SKIMLINKS_ID);
const affiliateHref = useSkim ? product.website : (affiliate?.url || product.website);
const f = freshness[product.slug];
---

<BaseLayout {title} {description}>
	<script type="application/ld+json" is:inline>{JSON.stringify({
		"@context": "https://schema.org",
		"@type": "SoftwareApplication",
		"name": product.name,
		"url": `https://bochi-it-note.com/products/${product.slug}`,
		"applicationCategory": product.category?.[0] || "Software",
		"operatingSystem": "Any",
		"offers": { "@type": "Offer", "price": product.pricing?.enterprise ? "Contact" : "0", "priceCurrency": "JPY" }
	})}</script>
	<Breadcrumb items={[{name:'製品', href:'/products/'},{name:product.name}]} />
	<article class="prose prose-zinc max-w-none mt-3">
		<h1>{product.name}</h1>
		<p><a data-track="out_website" data-type="product" data-slug={product.slug} href={product.website} target="_blank" rel="noopener">公式サイト</a></p>
		{affiliate && <p class="mt-2"><a data-track="out_affiliate" data-type="product" data-slug={product.slug} class="inline-flex items-center gap-1 rounded-md bg-gray-900 px-3 py-2 text-sm text-white hover:bg-black" href={affiliateHref} target="_blank" rel="nofollow noopener sponsored">公式サイト（紹介）へ</a></p>}
		{f?.needsReview && <p class="mt-2 inline-flex items-center rounded bg-yellow-100 px-2 py-1 text-xs text-yellow-800">要確認: 出典の変更が検知されました</p>}
		<h2>要件適合（抜粋）</h2>
		<ul>
			<li>SSO: {product.features.sso ? '対応' : '未対応'}</li>
			<li>SCIM: {product.features.scim ? '対応' : '未対応'}</li>
			<li>IP制限: {product.features.ipAllowlist ? '対応' : '未対応'}</li>
			<li>監査ログ: {product.features.auditLog}</li>
			<li>データ所在: {product.features.dataResidency}</li>
			<li>保持期間: {product.features.retentionDays !== null ? `${product.features.retentionDays}日` : '不明/プラン依存'}</li>
			<li>権限粒度: {product.features.rolesGranularity}</li>
		</ul>
		<h3>出典</h3>
		<ul>
			{product.sources.map(s => <li><a href={s.url} target="_blank" rel="nofollow noopener">{s.title}<span aria-hidden="true" class="ml-1">↗</span></a>（確認日: {s.checked_at}）</li>)}
		</ul>
		<p class="text-sm text-gray-500">最終確認日: {product.last_verified}</p>
	</article>
	<SponsorSlot context="product" tags={product.category} />
	{related.length > 0 && (
		<section class="mt-10">
			<h2 class="text-lg font-semibold">この製品を含む比較</h2>
			<ul class="mt-3 grid gap-3 sm:grid-cols-2">
				{related.map(c => (
					<li class="rounded-md border p-4">
						<a href={`/compare/${c.slug}`} class="font-semibold hover:underline">{products.find(p => p.slug === c.productA)?.name} vs {products.find(p => p.slug === c.productB)?.name}</a>
						<p class="mt-1 text-sm text-gray-600">{c.summary}</p>
					</li>
				))}
			</ul>
			<div class="mt-4">
				<a href={`/alternatives/${product.slug}`} class="text-sm underline">{product.name} の代替を見る</a>
				<span class="mx-2 text-gray-400">/</span>
				<a href="/compare/" class="text-sm underline">比較一覧に戻る</a>
			</div>
		</section>
	)}
	<div class="mt-8"></div>
</BaseLayout>


